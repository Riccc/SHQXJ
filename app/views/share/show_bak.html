<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <title>æˆ‘çš„å¤©æ°”é¢„æŠ¥</title>
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: #f0f2f5;
    }

    /* ä¸»å®¹å™¨ */
    #main-container {
  display: flex;
  justify-content: center; /* å±…ä¸­å¯¹é½ */
  padding: 20px;
  height: calc(100vh - 40px);
  box-sizing: border-box;
  flex-wrap: nowrap;
  align-items: flex-start;
  gap: 20px; /* å¢åŠ å­é¡¹é—´è· */
}

    /* å¡ç‰‡å®¹å™¨ï¼šé»˜è®¤æ¨ªå±16:9æ¯”ä¾‹ */
    #card-container {
      width: 768px;
      height: 881.28px; /* 16:9 */
      margin-bottom: 20px;
      box-sizing: border-box;
      flex-shrink: 0;
    }

    /* å¡ç‰‡å®½é«˜æ’‘æ»¡å®¹å™¨ */
    #card {
      width: 100%;
      height: 100%;
      border-radius: 15px;
      overflow: hidden;
      background-size: cover;
      background-position: center;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      position: relative;
    }

    /* ä¸­å±å¹³æ¿ä¾ç„¶æ¨ªå±16:9ï¼Œä½†å®½åº¦ç¼©å° */
    @media screen and (max-width: 900px) {
      #card-container {
        width: 400px;
        height: 225px; /* 16:9 */
      }
    }

    /* å°å±æ‰‹æœºç«–å±æ¯”ä¾‹è°ƒæ•´ */
    @media screen and (max-width: 480px) {
      #main-container {
        flex-direction: column;
        align-items: center;
        padding: 10px;
        height: auto;
      }

      #card-container {
        width: 320px;
        height: 568px; /* 9:16 ç«–å±æ¯”ä¾‹ */
        margin-bottom: 15px;
      }

      #side-content {
        width: 100%;
        margin-top: 15px;
      }
    }

    /* ä¾§è¾¹å†…å®¹ */
    #side-content {
      width: 240px;
      background: linear-gradient(135deg, #fdfbfb, #ebedee);
      padding: 20px;
      border-radius: 16px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      text-align: center;
      display: flex;
      flex-direction: column;
      align-items: center;
      box-sizing: border-box;
      height: fit-content;
      flex-shrink: 0;
    }

    /* å¤´åƒ */
    #avatar {
      position: absolute;
      top: 25%;
      left: 50%;
      transform: translateX(-50%);
      border-radius: 50%;
      border: 4px solid white;
      width: 120px;
      height: 120px;
      object-fit: cover;
      z-index: 2;
    }

    /* åå­— */
    #name-label {
      position: absolute;
      top: calc(25% + 120px + 15px);
      left: 50%;
      transform: translateX(-50%);
      font-size: 1.2rem;
      font-weight: bold;
      background: rgba(255, 255, 255, 0.7);
      padding: 4px 10px;
      border-radius: 8px;
      z-index: 2;
    }

    /* é¡¶éƒ¨æ–‡å­—åŒºåŸŸ */
    #text-container {
      position: absolute;
      top: 5%;
      left: 50%;
      transform: translateX(-50%);
      text-align: center;
      width: 90%;
      z-index: 2;
      margin-bottom: 20px;
    }

    #line1, #line2 {
      margin: 0;
      font-weight: bold;
      color: #333;
    }

    #line1 {
      font-size: 2rem;
    }

    #line2 {
      font-size: 1.4rem;
      white-space: nowrap;
    }

    /* infoåŒºåŸŸ */
    #info-container {
      position: absolute;
      bottom: 20px;
      left: 5%;
      background: rgba(255, 255, 255, 0.4);
      border-radius: 12px;
      padding: 12px;
      max-width: 90%;
      box-sizing: border-box;
      font-size: 0.85rem;
      z-index: 3;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .info-row {
      display: flex;
      flex-wrap: nowrap;
      justify-content: space-between;
      align-items: flex-start;
      gap: 12px;
    }

    .full-width {
      width: 100%;
    }

    .info-column {
      flex: 1;
      min-width: 120px;
      text-align: center;
    }

    .info-column h3 {
      margin: 0 0 4px;
      font-size: 0.95rem;
    }

    .info-column p {
      margin: 2px 0;
      word-break: break-word;
    }

    .image-column {
      flex: 0 0 auto;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .image-column img {
      max-width: 80px;
      max-height: 80px;
      object-fit: contain;
    }

    /* äºŒç»´ç æ ·å¼ */
#qrcode {
  display: flex;
  justify-content: center;
  align-items: center;
  width: 100%;
  height: 128px;
  padding: 10px;
  background: white;
  border-radius: 12px;
  box-shadow: inset 0 0 4px rgba(0, 0, 0, 0.05);
  cursor: pointer;
  transition: transform 0.2s ease-in-out;
} 
#qrcode > div {
  margin: 0 auto;
}

    #qrcode:hover {
      transform: scale(1.05);
    }

    #side-content p {
      margin-top: 10px;
      font-size: 0.95rem;
      color: #666;
    }

    /* äºŒç»´ç åŠ è½½åŠ¨ç”» */
    #qrcode .loading-spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #3498db;
      border-radius: 50%;
      width: 32px;
      height: 32px;
      animation: spin 1s linear infinite;
      margin: 0 auto;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

  </style>
</head>
<body>
  <div id="main-container">
    <div id="card-container">
      <div id="card" class="container-16-9">
        <img id="avatar" />
        <% if @name.present? %>
        <div id="name-label"><%= @name %></div>
        <% else %>
        <div id="name-label">æ¸¸å®¢</div>
        <% end %>

        <div id="text-container">
          <p id="line1">æˆ‘æ˜¯å°å°é¢„æŠ¥å‘˜</p>
          <p id="line2">ä»Šå¤©æˆ‘åœ¨ä¸Šæµ·æ°”è±¡åšç‰©é¦†é¢„æŠ¥å¤©æ°”</p>
        </div>

        <div id="info-container">
          <div class="info-row first-row">
            <div class="info-column">
              <h3>æˆ‘çš„é¢„æŠ¥</h3>
              <p><%= @chosen_date %></p>
              <p><%= @low_temp %>~<%= @high_temp %></p>
              <p><%= @chosen_text %></p>
            </div>
            <div class="image-column">
              <img id="weather-image" src="<%= @chosen_img %>" alt="å¤©æ°”å›¾ç‰‡" />
            </div>
          </div>

          <div class="info-row first-row">
            <div class="info-column">
              <h3>ç”Ÿæ—¥å¤©æ°”</h3>
              <p><%= @birthday %></p>
              <% if @birthday_weather_data.present? %>
                <p><%= @birthday_weather_data[:avg_temp] %>â„ƒ / <%= @birthday_weather_data[:max_temp] %>â„ƒ</p>
                <p><%= @birthday_weather_data[:weather_summary] %></p>
                <p>é™æ°´ <%= @birthday_weather_data[:precipitation] %>mm</p>
              <% else %>
                <p>è¶…å‡ºæ•°æ®èŒƒå›´å•¦ï¼Œ</p>
                <p>ä½†æ˜¯ä¸€å®šæ˜¯ä¸ªå¥½å¤©æ°”ã€‚</p>
              <% end %>
            </div>
            <div class="image-column">
      <!-- å ä½å›¾ï¼Œä¹Ÿå¯ä»¥ç”¨é€æ˜å›¾åƒæˆ–ç©º div -->
      <div style="width: 80px; height: 80px;"></div>
    </div>
          </div>
        </div>
      </div>
    </div>

    <div id="side-content">
      <h3>ğŸ“¤ åˆ†äº«å½“å‰é¢„æŠ¥</h3>
      <p class="desc">æ‰«æä¸‹æ–¹äºŒç»´ç ï¼Œä¸æœ‹å‹åˆ†äº«ä½ çš„ä¸“å±å¤©æ°”é¢„æŠ¥</p>
      <div id="qrcode">
        <div class="loading-spinner"></div>
      </div>
    </div>
  </div>

  <script src="/js/html2canvas.min.js"></script>
  <script src="/js/qrcode.min.js"></script>
  <script>
    document.addEventListener("DOMContentLoaded", function () {
      const uploadedBackgroundImage = localStorage.getItem("uploadedBackgroundImage");
      const uploadedImage = localStorage.getItem("uploadedImage");

      const card = document.getElementById("card");
      const avatar = document.getElementById("avatar");
      const qrContainer = document.getElementById("qrcode");

      function showLoading() {
        qrContainer.innerHTML = '<div class="loading-spinner"></div>';
      }

      function takeScreenshot() {
        showLoading();

        // æˆªå›¾cardï¼Œscale=2ä¿è¯æ¸…æ™°
        html2canvas(card, { scale: 2 }).then(canvas => {
          const imgData = canvas.toDataURL("image/png");

          fetch("/upload_image", {
            method: "POST",
            headers: {
              "Content-Type": "application/json"
            },
            body: JSON.stringify({ image: imgData })
          })
          .then(response => response.json())
          .then(data => {
            if (data.url) {
              qrContainer.innerHTML = "";
              new QRCode(qrContainer, {
                text: data.url,
                width: 128,
                height: 128
              });
            } else {
              qrContainer.innerText = "äºŒç»´ç ç”Ÿæˆå¤±è´¥";
              console.error("åå°è¿”å›æ— æ•ˆURL", data);
            }
          })
          .catch(err => {
            qrContainer.innerText = "äºŒç»´ç ç”Ÿæˆå¤±è´¥";
            console.error("ä¸Šä¼ å›¾ç‰‡å¤±è´¥", err);
          });
        });
      }

      // è®¾ç½®èƒŒæ™¯å›¾
      const defaultAvatar = "<%= asset_path('default_avatar.png') %>";
      const defaultBackground = "<%= asset_path('default_background.png') %>";

      if (uploadedBackgroundImage) {
        card.style.backgroundImage = `url(${uploadedBackgroundImage})`;
      } else {
        card.style.backgroundImage = `url(${defaultBackground})`;
        card.style.backgroundSize = "contain"; // é»˜è®¤å›¾å®Œæ•´æ˜¾ç¤º
        card.style.backgroundRepeat = "no-repeat";
        card.style.backgroundPosition = "center";
      }

      // è®¾ç½®å¤´åƒ
      if (uploadedImage) {
        avatar.src = uploadedImage;
      } else {
        avatar.src = defaultAvatar;
      }

      // é¡µé¢åŠ è½½å®Œæˆåç”ŸæˆäºŒç»´ç 
      takeScreenshot();
    });
  </script>
</body>
</html>
