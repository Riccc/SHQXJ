<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <title>æˆ‘çš„å¤©æ°”é¢„æŠ¥</title>
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: #f0f2f5;
    }

    /* ä¸»å®¹å™¨ */
    #main-container {
      display: flex;
      justify-content: center; /* å±…ä¸­å¯¹é½ */
      padding: 20px;
      height: calc(100vh - 40px);
      box-sizing: border-box;
      flex-wrap: nowrap;
      align-items: flex-start;
      gap: 20px; /* å¢åŠ å­é¡¹é—´è· */
    }

    /* å¡ç‰‡å®¹å™¨é»˜è®¤å®½é«˜ï¼Œå…ˆä¸å†™å›ºå®šå®½é«˜ï¼Œæ”¹ç”¨ç±»æ§åˆ¶ */
    #card-container {
      margin-bottom: 20px;
      box-sizing: border-box;
      flex-shrink: 0;
      transition: width 0.3s ease, height 0.3s ease;
    }

    /* æ¨ªå›¾æ¯”ä¾‹å¡ç‰‡ï¼š16:9ï¼Œå°ºå¯¸åŠ å¤§ */
    .card-landscape {
      width: 960px;
      height: 540px; /* 960 / 16 * 9 */
    }

    /* ç«–å›¾æ¯”ä¾‹å¡ç‰‡ï¼š9:16ï¼Œå°ºå¯¸åŠ å¤§ */
    .card-portrait {
      width: 768px;
      height: 881.28px; /* 500 / 9 * 16 */
    }

    /* å¡ç‰‡å®½é«˜æ’‘æ»¡å®¹å™¨ */
    #card {
      width: 100%;
      height: 100%;
      border-radius: 15px;
      overflow: hidden;
      background-size: cover;
      background-position: center;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      position: relative;
    }

    /* ä¸­å±å¹³æ¿ä¾ç„¶æ¨ªå±16:9ï¼Œä½†å®½åº¦ç¼©å° */
    @media screen and (max-width: 900px) {
      #card-container.card-landscape {
        width: 500px;
        height: 281px; /* 16:9 */
      }
      #card-container.card-portrait {
        width: 300px;
        height: 533.33px; /* 300 / 9 * 16 */
      }
    }

    /* å°å±æ‰‹æœºç«–å±æ¯”ä¾‹è°ƒæ•´ */
    @media screen and (max-width: 480px) {
      #main-container {
        flex-direction: column;
        align-items: center;
        padding: 10px;
        height: auto;
      }

      #card-container.card-landscape {
        width: 320px;
        height: 180px; /* 16:9 */
        margin-bottom: 15px;
      }
      #card-container.card-portrait {
        width: 320px;
        height: 568px; /* 9:16 ç«–å±æ¯”ä¾‹ */
        margin-bottom: 15px;
      }

      #side-content {
        width: 100%;
        margin-top: 15px;
      }
    }

    /* ä¾§è¾¹å†…å®¹ */
    #side-content {
      width: 240px;
      background: linear-gradient(135deg, #fdfbfb, #ebedee);
      padding: 20px;
      border-radius: 16px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      text-align: center;
      display: flex;
      flex-direction: column;
      align-items: center;
      box-sizing: border-box;
      height: fit-content;
      flex-shrink: 0;
    }

    /* å¤´åƒ */
    #avatar {
      position: absolute;
      top: 25%;
      left: 50%;
      transform: translateX(-50%);
      border-radius: 50%;
      border: 4px solid white;
      width: 120px;
      height: 120px;
      object-fit: cover;
      z-index: 2;
    }

    /* åå­— */
    #name-label {
      position: absolute;
      top: calc(25% + 120px + 15px);
      left: 50%;
      transform: translateX(-50%);
      font-size: 1.2rem;
      font-weight: bold;
      background: rgba(255, 255, 255, 0.7);
      padding: 4px 10px;
      border-radius: 8px;
      z-index: 2;
    }

    /* é¡¶éƒ¨æ–‡å­—åŒºåŸŸ */
    #text-container {
      position: absolute;
      top: 5%;
      left: 50%;
      transform: translateX(-50%);
      text-align: center;
      width: 90%;
      z-index: 2;
      margin-bottom: 20px;
    }

    #line1, #line2 {
      margin: 0;
      font-weight: bold;
      color: #333;
    }

    #line1 {
      font-size: 2rem;
    }

    #line2 {
      font-size: 1.4rem;
      white-space: nowrap;
    }

    /* infoåŒºåŸŸ */
 #info-container {
  position: absolute;
  top: 63%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: rgba(255, 255, 255, 0);
  border-radius: 16px;
  padding: 24px 32px;
  max-width: 70%;
  box-sizing: border-box;
  font-size: 1rem;
  line-height: 1.8; /* æ›´å¥½çš„å¯è¯»æ€§ */
  z-index: 3;
  display: flex;
  flex-direction: column;
  gap: 5px; /* æ¯è¡Œé—´è·å˜å¤§ */
}

#info-container-cross {
  position: absolute;
  top: 53%;
  left: 30%;
  transform: translate(-50%, -50%);
  background: rgba(255, 255, 255, 0);
  border-radius: 16px;
  padding: 24px 32px;
  max-width: 70%;
  box-sizing: border-box;
  font-size: 1rem;
  line-height: 1.8; /* æ›´å¥½çš„å¯è¯»æ€§ */
  z-index: 3;
  display: flex;
  flex-direction: column;
  gap: 5px; /* æ¯è¡Œé—´è·å˜å¤§ */
}

#info-container-vertical {
  position: absolute;
  top: 90%;
  left: 35%;
  transform: translate(-50%, -50%);
  background: rgba(255, 255, 255, 0);
  border-radius: 16px;
  padding: 24px 32px;
  max-width: 70%;
  box-sizing: border-box;
  font-size: 1rem;
  line-height: 1.8; /* æ›´å¥½çš„å¯è¯»æ€§ */
  z-index: 3;
  display: flex;
  flex-direction: column;
  gap: 5px; /* æ¯è¡Œé—´è·å˜å¤§ */
}

    .info-row {
      display: flex;
      flex-wrap: nowrap;
      justify-content: space-between;
      align-items: flex-start;
      gap: 12px;
    }

    .full-width {
      width: 100%;
    }

    .info-column {
      flex: 1;
      min-width: 120px;
      text-align: left;
    }

    .info-column h3 {
      margin: 0 0 4px;
      font-size: 0.95rem;
    }

    .info-column p {
      margin: 2px 0;
      word-break: break-word;
    }

    .image-column {
      flex: 1;
      min-width: 120px;
      text-align: center;
    }

    .image-column img {
      max-width: 80px;
      max-height: 80px;
      object-fit: contain;
    }

    /* äºŒç»´ç æ ·å¼ */
    #qrcode {
      display: flex;
      justify-content: center;
      align-items: center;
      width: 100%;
      height: 128px;
      padding: 10px;
      background: white;
      border-radius: 12px;
      box-shadow: inset 0 0 4px rgba(0, 0, 0, 0.05);
      cursor: pointer;
      transition: transform 0.2s ease-in-out;
    } 
    #qrcode > div {
      margin: 0 auto;
    }

    #qrcode:hover {
      transform: scale(1.05);
    }

    #side-content p {
      margin-top: 10px;
      font-size: 0.95rem;
      color: #666;
    }

    /* äºŒç»´ç åŠ è½½åŠ¨ç”» */
    #qrcode .loading-spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #3498db;
      border-radius: 50%;
      width: 32px;
      height: 32px;
      animation: spin 1s linear infinite;
      margin: 0 auto;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div id="main-container">
    <div id="card-container" class="card-landscape">
      <div id="card" class="container-16-9">
        <img id="avatar" />
        <% if @name.present? %>
        <div id="name-label"><%= @name %></div>
        <% else %>
        <div id="name-label">æ¸¸å®¢</div>
        <% end %>

        <div id="text-container">
          <p id="line1">æˆ‘æ˜¯å°å°é¢„æŠ¥å‘˜</p>
          <p id="line2">ä»Šå¤©æˆ‘åœ¨ä¸Šæµ·æ°”è±¡åšç‰©é¦†é¢„æŠ¥å¤©æ°”</p>
        </div>

        <div id="info-container" style="display:none;">
          <div class="info-row first-row">
            <div class="info-column">
              <h3 style="color:#ff801c;">æˆ‘çš„é¢„æŠ¥</h3>
              <p><%= @chosen_date %></p>
              <p style="font-weight:700;font-family:DINBold;"><%= @low_temp %>â„ƒ -<%= @high_temp %>â„ƒ</p>
              <p><%= @selected_text_content %></p>
            </div>
            <div class="image-column">
              <img id="weather-image" src="<%= @chosen_img %>" alt="å¤©æ°”å›¾ç‰‡" />
              <p><%= @chosen_text %></p>
            </div>
          </div>

          <div class="info-row first-row">
            <div class="info-column">
              <h3 style="color:#ff801c;">ç”Ÿæ—¥å¤©æ°”</h3>
              <p><%= @birthday %></p>
              <% if @birthday_weather_data.present? %>
                <p><%= @birthday_weather_data[:avg_temp] %>â„ƒ / <%= @birthday_weather_data[:max_temp] %>â„ƒ</p>
                <p><%= @birthday_weather_data[:weather_summary] %></p>
                <p>é™æ°´ <%= @birthday_weather_data[:precipitation] %>mm</p>
              <% else %>
                <p>è¶…å‡ºæ•°æ®èŒƒå›´å•¦ï¼Œ</p>
                <p>ä½†æ˜¯ä¸€å®šæ˜¯ä¸ªå¥½å¤©æ°”ã€‚</p>
              <% end %>
            </div>
            <!-- <div class="image-column">
              <div style="width: 80px; height: 80px;"></div>
            </div> -->
          </div>
        </div>
      </div>

      <div id="info-container-cross" style="display:none;">
          <div class="info-row first-row">
            <div class="info-column">
              <h3 style="color:#ff801c;">æˆ‘çš„é¢„æŠ¥</h3>
              <p><%= @chosen_date %></p>
              <p style="font-weight:700;font-family:DINBold;"><%= @low_temp %>â„ƒ -<%= @high_temp %>â„ƒ</p>
              <p><%= @selected_text_content %></p>
            </div>
            <div class="image-column">
              <img id="weather-image" src="<%= @chosen_img %>" alt="å¤©æ°”å›¾ç‰‡" />
              <p><%= @chosen_text %></p>
            </div>
          </div>

          <div class="info-row first-row">
            <div class="info-column">
              <h3 style="color:#ff801c;">ç”Ÿæ—¥å¤©æ°”</h3>
              <p><%= @birthday %></p>
              <% if @birthday_weather_data.present? %>
                <p><%= @birthday_weather_data[:avg_temp] %>â„ƒ / <%= @birthday_weather_data[:max_temp] %>â„ƒ</p>
                <p><%= @birthday_weather_data[:weather_summary] %></p>
                <p>é™æ°´ <%= @birthday_weather_data[:precipitation] %>mm</p>
              <% else %>
                <p>è¶…å‡ºæ•°æ®èŒƒå›´å•¦ï¼Œ</p>
                <p>ä½†æ˜¯ä¸€å®šæ˜¯ä¸ªå¥½å¤©æ°”ã€‚</p>
              <% end %>
            </div>
            <!-- <div class="image-column">
              <div style="width: 80px; height: 80px;"></div>
            </div> -->
          </div>
        </div>
      </div>

      <div id="info-container-vertical" style="display:none;">
          <div class="info-row first-row">
            <div class="info-column">
              <h3 style="color:#ff801c;">æˆ‘çš„é¢„æŠ¥</h3>
              <p><%= @chosen_date %></p>
              <p style="font-weight:700;font-family:DINBold;"><%= @low_temp %>â„ƒ -<%= @high_temp %>â„ƒ</p>
              <p><%= @selected_text_content %></p>
            </div>
            <div class="image-column">
              <img id="weather-image" src="<%= @chosen_img %>" alt="å¤©æ°”å›¾ç‰‡" />
              <p><%= @chosen_text %></p>
            </div>
          </div>

          <div class="info-row first-row">
            <div class="info-column">
              <h3 style="color:#ff801c;">ç”Ÿæ—¥å¤©æ°”</h3>
              <p><%= @birthday %></p>
              <% if @birthday_weather_data.present? %>
                <p><%= @birthday_weather_data[:avg_temp] %>â„ƒ / <%= @birthday_weather_data[:max_temp] %>â„ƒ</p>
                <p><%= @birthday_weather_data[:weather_summary] %></p>
                <p>é™æ°´ <%= @birthday_weather_data[:precipitation] %>mm</p>
              <% else %>
                <p>è¶…å‡ºæ•°æ®èŒƒå›´å•¦ï¼Œ</p>
                <p>ä½†æ˜¯ä¸€å®šæ˜¯ä¸ªå¥½å¤©æ°”ã€‚</p>
              <% end %>
            </div>
            <!-- <div class="image-column">
              <div style="width: 80px; height: 80px;"></div>
            </div> -->
          </div>
        </div>
      </div>
    </div>

    <div id="side-content">
      <h3>ğŸ“¤ åˆ†äº«å½“å‰é¢„æŠ¥</h3>
      <p class="desc">æ‰«æä¸‹æ–¹äºŒç»´ç ï¼Œä¸æœ‹å‹åˆ†äº«ä½ çš„ä¸“å±å¤©æ°”é¢„æŠ¥</p>
      <div id="qrcode">
        <div class="loading-spinner"></div>
      </div>
    </div>
  </div>

  <script src="/js/html2canvas.min.js"></script>
  <script src="/js/qrcode.min.js"></script>
  <script>
    document.addEventListener("DOMContentLoaded", function () {
      const card = document.getElementById("card");
      const cardContainer = document.getElementById("card-container");
      const infoContainer = document.getElementById("info-container");
      const infoContainerCross = document.getElementById("info-container-cross");
      const infoContainerVertical = document.getElementById("info-container-vertical");
      const avatar = document.getElementById("avatar");

      // è¯»å–å¤´åƒå’ŒèƒŒæ™¯å›¾
      const uploadedImage = localStorage.getItem("uploadedImage");
      const uploadedBackgroundImage = localStorage.getItem("uploadedBackgroundImage");

      const qrContainer = document.getElementById("qrcode");

      function showLoading() {
        qrContainer.innerHTML = '<div class="loading-spinner"></div>';
      }

      function takeScreenshot() {
        showLoading();

        // æˆªå›¾cardï¼Œscale=2ä¿è¯æ¸…æ™°
        html2canvas(card, { scale: 2 }).then(canvas => {
          const imgData = canvas.toDataURL("image/png");

          fetch("/upload_image", {
            method: "POST",
            headers: {
              "Content-Type": "application/json"
            },
            body: JSON.stringify({ image: imgData })
          })
          .then(response => response.json())
          .then(data => {
            if (data.url) {
              qrContainer.innerHTML = "";
              new QRCode(qrContainer, {
                text: data.url,
                width: 128,
                height: 128
              });
            } else {
              qrContainer.innerText = "äºŒç»´ç ç”Ÿæˆå¤±è´¥";
              console.error("åå°è¿”å›æ— æ•ˆURL", data);
            }
          })
          .catch(err => {
            qrContainer.innerText = "äºŒç»´ç ç”Ÿæˆå¤±è´¥";
            console.error("ä¸Šä¼ å›¾ç‰‡å¤±è´¥", err);
          });
        });
      }
      const defaultAvatar = "<%= asset_path('default_avatar.png') %>";
      // å¤´åƒå¤„ç†
      if (uploadedImage) {
        avatar.src = uploadedImage;
      } else {
        avatar.src = defaultAvatar;
      }

      // èƒŒæ™¯å¤„ç†åŠå®¹å™¨å°ºå¯¸åˆ¤æ–­
      const defaultBackground = "<%= asset_path('default_background_1.png') %>";

      if (uploadedBackgroundImage) {
        const img = new Image();
        img.onload = function () {
          const width = img.width;
          const height = img.height;
          const aspectRatio = width / height;

          // æ¸…é™¤æ‰€æœ‰å°ºå¯¸ç±»
          cardContainer.classList.remove("card-portrait", "card-landscape");

          // åˆ¤æ–­æ¯”ä¾‹ï¼Œå°äº0.9è®¤ä¸ºæ˜¯ç«–å›¾ï¼Œå…¶ä»–æ¨ªå›¾
          if (aspectRatio < 0.9) {
            infoContainer.style.display = 'none';
            infoContainerVertical.style.display = '';
            infoContainerCross.style.display = 'none';
            cardContainer.classList.add("card-portrait");
          } else {
            infoContainer.style.display = 'none';
            infoContainerVertical.style.display = 'none';
            infoContainerCross.style.display = '';
            cardContainer.classList.add("card-landscape");
          }

          card.style.backgroundImage = `url(${uploadedBackgroundImage})`;
          card.style.backgroundSize = "cover";
          card.style.backgroundRepeat = "no-repeat";
          card.style.backgroundPosition = "center";
        };
        img.src = uploadedBackgroundImage;
      } else {
        infoContainer.style.display = '';
        infoContainerVertical.style.display = 'none';
        infoContainerCross.style.display = 'none';
        // é»˜è®¤èƒŒæ™¯ï¼Œä½¿ç”¨ç«–å±æ¯”ä¾‹
        cardContainer.classList.remove("card-landscape");
        cardContainer.classList.add("card-portrait");

        card.style.backgroundImage = `url(${defaultBackground})`;
        card.style.backgroundSize = "contain";
        card.style.backgroundRepeat = "no-repeat";
        card.style.backgroundPosition = "center";
      }

      // é¡µé¢åŠ è½½å®Œæˆåç”ŸæˆäºŒç»´ç 
      takeScreenshot();
    });
  </script>
</body>
</html>